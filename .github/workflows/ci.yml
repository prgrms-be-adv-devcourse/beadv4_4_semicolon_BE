name: PR Build & Test

on:
  pull_request:
    branches: [ dev ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 1. 환경 변수 설정
    env:
      SPRING_PROFILES_ACTIVE: dev
      # DB 설정 (Runner에서 접속하므로 localhost)
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: semicolon
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_SSLMODE: disable
      # Elasticsearch 설정
      SPRING_ELASTICSEARCH_URIS: http://localhost:9200

    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 25
        uses: actions/setup-java@v1
        with:
          java-version: 25

      # 2. 통합 테스트 환경 구성을 위한 docker-compose 파일 생성
      - name: Create docker-compose.ci.yml
        run: |
          cat <<EOF > docker-compose.ci.yml
          version: "3.8"
          services:
            elasticsearch:
              image: docker.elastic.co/elasticsearch/elasticsearch:9.2.2
              container_name: semicolon-elasticsearch
              environment:
                - discovery.type=single-node
                - xpack.security.enabled=false
                - ES_JAVA_OPTS=-Xms512m -Xmx512m
              ports:
                - "9200:9200"
              command: >
                /bin/sh -c "
                  if ! ./bin/elasticsearch-plugin list | grep -q analysis-nori; then
                    ./bin/elasticsearch-plugin install analysis-nori;
                  fi;
                  /usr/local/bin/docker-entrypoint.sh elasticsearch
                "
            
            redis:
              image: redis:7.2
              container_name: semicolon-redis
              ports:
                - "6379:6379"

            postgres:
              image: postgres:18.1
              container_name: semicolon-postgres
              environment:
                POSTGRES_DB: ${{ env.DB_NAME }}
                POSTGRES_USER: ${{ env.DB_USERNAME }}
                POSTGRES_PASSWORD: ${{ env.DB_PASSWORD }}
              ports:
                - "5432:5432"
          EOF

      # 3. Docker Compose 실행 (수정됨: docker-compose -> docker compose)
      - name: Start Containers (ES, Redis, Postgres)
        run: docker compose -f docker-compose.ci.yml up -d

      # 4. 컨테이너가 완전히 뜰 때까지 대기
      - name: Wait for services to be ready
        run: |
          echo "Waiting for Elasticsearch..."
          # ES가 응답할 때까지 최대 60초 대기 (단순 sleep보다 안전)
          timeout 60s bash -c 'until curl -s http://localhost:9200 > /dev/null; do sleep 5; done' || echo "ES didn't start in time"
          echo "Elasticsearch is up!"
          
          echo "Waiting for Postgres..."
          sleep 10 

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. 빌드 수행 (Test 포함)
      - name: Build with Gradle
        run: ./gradlew clean build --no-daemon --info
        
      # 6. 빌드 실패 시 로그 확인 (수정됨: docker-compose -> docker compose)
      - name: Print Container Logs on Failure
        if: failure()
        run: docker compose -f docker-compose.ci.yml logs
